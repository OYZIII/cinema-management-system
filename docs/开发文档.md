# 影院管理系统开发文档

## 项目概述

影院管理系统是一个基于 Spring Boot + React 的全栈 Web 应用，实现了影院的核心业务功能，包括电影管理、排片管理、在线购票、订单管理等。

## 技术选型

### 后端技术栈

| 技术 | 版本 | 说明 |
|------|------|------|
| Spring Boot | 2.7.0 | 基础框架 |
| MyBatis-Plus | 3.5.2 | ORM框架 |
| MySQL | 8.0 | 数据库 |
| Redis | 6.2 | 缓存 |
| JWT | 0.9.1 | 认证方案 |
| Druid | 1.2.11 | 数据库连接池 |
| Hutool | 5.8.16 | 工具包 |

### 前端技术栈

| 技术 | 版本 | 说明 |
|------|------|------|
| React | 18.2.0 | 前端框架 |
| TypeScript | 4.9.5 | 类型系统 |
| Ant Design | 5.0.0 | UI组件库 |
| Axios | 1.3.0 | HTTP客户端 |
| React Router | 6.8.0 | 路由管理 |
| ECharts | 5.4.1 | 数据可视化 |

## 核心功能模块

### 1. 用户模块

**功能点:**
- 用户注册/登录
- JWT token认证
- 用户信息管理
- 权限控制（管理员/普通用户）

**技术实现:**
- 密码使用 MD5 加密存储
- 使用 JWT 实现无状态认证
- 通过拦截器验证 token 有效性

**核心代码:**

```java
// JWT生成
public static String generateToken(Long userId) {
    return Jwts.builder()
        .setSubject(String.valueOf(userId))
        .setIssuedAt(new Date())
        .setExpiration(new Date(System.currentTimeMillis() + EXPIRATION))
        .signWith(SignatureAlgorithm.HS512, SECRET)
        .compact();
}
```

### 2. 电影管理模块

**功能点:**
- 电影信息的增删改查
- 电影搜索（支持名称、导演、演员）
- 电影分类（正在热映/即将上映/已下架）
- 电影详情展示

**技术实现:**
- 使用 MyBatis-Plus 进行数据库操作
- 实现动态查询条件
- 分页查询优化

**核心代码:**

```java
LambdaQueryWrapper<Movie> wrapper = new LambdaQueryWrapper<>();
if (StrUtil.isNotBlank(keyword)) {
    wrapper.like(Movie::getName, keyword)
           .or()
           .like(Movie::getDirector, keyword);
}
wrapper.eq(Movie::getStatus, status)
       .orderByDesc(Movie::getRating);
```

### 3. 影厅管理模块

**功能点:**
- 影厅信息管理
- 座位布局配置
- 影厅类型设置（2D/3D/IMAX）
- 影厅状态管理

**技术实现:**
- 座位布局使用 JSON 格式存储
- 灵活配置行列数
- 自动计算总座位数

### 4. 排片管理模块

**功能点:**
- 排片信息管理
- 场次时间设置
- 票价设置
- 已售座位统计

**技术实现:**
- 按日期分组展示排片
- 实时统计座位销售情况
- 时间冲突检测（可扩展）

**核心代码:**

```java
// 按日期分组
Map<LocalDate, List<Schedule>> groupedSchedules = schedules.stream()
    .collect(Collectors.groupingBy(s -> s.getStartTime().toLocalDate()));
```

### 5. 购票系统模块

**功能点:**
- 在线选座
- 实时座位状态展示
- 订单创建
- 支付模拟

**技术实现:**
- 前端实时渲染座位状态
- 已售座位使用 Set 存储，快速判断
- 事务保证订单数据一致性

**核心代码:**

```java
@Transactional(rollbackFor = Exception.class)
public Order createOrder(Long userId, OrderDTO orderDTO) {
    // 创建订单
    Order order = new Order();
    // ...
    this.save(order);
    
    // 更新已售座位数
    schedule.setSoldCount(schedule.getSoldCount() + orderDTO.getSeats().size());
    scheduleService.updateById(schedule);
    
    return order;
}
```

### 6. 订单管理模块

**功能点:**
- 订单查询
- 订单状态管理（待支付/已支付/已取消/已退款）
- 订单取消
- 支付处理

**技术实现:**
- 使用雪花算法生成订单号
- 状态机模式管理订单状态
- 取消订单时恢复座位

### 7. 数据统计模块（管理后台）

**功能点:**
- 票房统计
- 用户数统计
- 订单数统计
- 数据可视化展示

**技术实现:**
- 使用 ECharts 展示图表
- 折线图展示票房趋势
- 饼图展示电影销售占比

## 数据库设计

### 核心表结构

#### 用户表 (user)

```sql
CREATE TABLE `user` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `username` varchar(50) NOT NULL,
  `password` varchar(100) NOT NULL,
  `real_name` varchar(50),
  `phone` varchar(20),
  `email` varchar(100),
  `role` int DEFAULT 0,
  `status` int DEFAULT 0,
  PRIMARY KEY (`id`)
);
```

#### 电影表 (movie)

```sql
CREATE TABLE `movie` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `name` varchar(100) NOT NULL,
  `director` varchar(100),
  `actors` varchar(500),
  `type` varchar(50),
  `duration` int,
  `rating` decimal(3,1),
  `status` int DEFAULT 0,
  PRIMARY KEY (`id`)
);
```

#### 订单表 (order_info)

```sql
CREATE TABLE `order_info` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `order_no` varchar(50) NOT NULL,
  `user_id` bigint NOT NULL,
  `schedule_id` bigint NOT NULL,
  `seats` text NOT NULL,
  `total_amount` decimal(10,2) NOT NULL,
  `status` int DEFAULT 0,
  PRIMARY KEY (`id`)
);
```

## 前端架构

### 目录结构

```
frontend/
├── src/
│   ├── components/      # 公共组件
│   │   └── Layout/      # 布局组件
│   ├── pages/           # 页面组件
│   │   ├── Home/        # 首页
│   │   ├── Login/       # 登录
│   │   ├── MovieList/   # 电影列表
│   │   ├── MovieDetail/ # 电影详情
│   │   ├── SeatSelection/ # 选座
│   │   ├── OrderList/   # 订单列表
│   │   └── admin/       # 管理后台
│   ├── services/        # API服务
│   ├── utils/           # 工具函数
│   └── App.tsx          # 根组件
```

### 状态管理

项目使用 React Hooks 进行状态管理：
- `useState` - 组件内部状态
- `useEffect` - 副作用处理
- `useNavigate` - 路由跳转

### API请求封装

使用 Axios 拦截器统一处理：
- 请求拦截：自动添加 token
- 响应拦截：统一错误处理
- 401 自动跳转登录

```typescript
request.interceptors.request.use((config: any) => {
  const token = localStorage.getItem('token');
  if (token) {
    config.headers.Authorization = token;
  }
  return config;
});
```

## 安全性设计

### 1. 认证授权

- JWT token 实现无状态认证
- token 过期时间设置为 7 天
- 敏感接口需要验证 token

### 2. 密码安全

- 密码使用 MD5 加密存储
- 登录接口限流（可扩展）

### 3. SQL注入防护

- 使用 MyBatis-Plus 预编译语句
- 参数化查询

### 4. XSS防护

- 前端输入验证
- 后端参数校验

## 性能优化

### 后端优化

1. **数据库优化**
   - 添加索引（user_id, schedule_id 等）
   - 使用连接池（Druid）
   - 逻辑删除代替物理删除

2. **缓存策略**（可扩展）
   - Redis 缓存热门电影
   - 缓存排片信息
   - 设置合理的过期时间

3. **分页查询**
   - 使用 MyBatis-Plus 分页插件
   - 避免一次性加载大量数据

### 前端优化

1. **路由懒加载**（可扩展）
2. **图片懒加载**（可扩展）
3. **组件缓存**（可扩展）
4. **打包优化**
   - 代码分割
   - Tree Shaking

## 扩展功能建议

1. **WebSocket 实时座位更新**
   - 多用户同时选座时实时同步

2. **支付集成**
   - 接入支付宝/微信支付

3. **优惠券系统**
   - 优惠券发放
   - 优惠券使用

4. **会员系统**
   - 会员等级
   - 积分系统

5. **评论系统**
   - 电影评论
   - 评分功能

6. **推荐系统**
   - 基于用户历史的推荐
   - 热门推荐

## 常见问题

### 1. 跨域问题

前端开发环境使用 proxy 代理：

```json
"proxy": "http://localhost:8080"
```

生产环境配置 CORS：

```java
@Configuration
public class CorsConfig implements WebMvcConfigurer {
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                .allowedOriginPatterns("*")
                .allowedMethods("*");
    }
}
```

### 2. Token 过期处理

响应拦截器自动处理：

```typescript
if (res.code === 401) {
  localStorage.removeItem('token');
  window.location.href = '/login';
}
```

### 3. 座位冲突问题

使用事务保证数据一致性，建议添加乐观锁或悲观锁机制。

## 总结

本系统采用前后端分离架构，技术栈成熟稳定，代码结构清晰，具有良好的可扩展性。通过合理的模块划分和规范的编码风格，便于后续维护和功能扩展。

