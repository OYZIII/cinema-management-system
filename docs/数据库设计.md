# 数据库设计文档

## 数据库概述

- **数据库名称**: cinema_db
- **字符集**: utf8mb4
- **排序规则**: utf8mb4_unicode_ci
- **存储引擎**: InnoDB

## 表设计

### 1. 用户表 (user)

**表名**: `user`

**表说明**: 存储用户基本信息，包括普通用户和管理员

**字段说明**:

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|--------|------|------|--------|--------|------|
| id | bigint |  | NO |  | 主键，自增 |
| username | varchar | 50 | NO |  | 用户名，唯一 |
| password | varchar | 100 | NO |  | 密码（MD5加密） |
| real_name | varchar | 50 | YES | NULL | 真实姓名 |
| phone | varchar | 20 | YES | NULL | 手机号 |
| email | varchar | 100 | YES | NULL | 邮箱 |
| avatar | varchar | 255 | YES | NULL | 头像URL |
| role | int |  | YES | 0 | 角色：0-普通用户，1-管理员 |
| status | int |  | YES | 0 | 状态：0-正常，1-禁用 |
| deleted | int |  | YES | 0 | 逻辑删除：0-未删除，1-已删除 |
| create_time | datetime |  | YES | CURRENT_TIMESTAMP | 创建时间 |
| update_time | datetime |  | YES | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_username` (`username`)

**示例数据**:

```sql
INSERT INTO user VALUES 
(1, 'admin', 'e10adc3949ba59abbe56e057f20f883e', '管理员', '13800138000', 'admin@cinema.com', NULL, 1, 0, 0, NOW(), NOW()),
(2, 'user', 'e10adc3949ba59abbe56e057f20f883e', '张三', '13800138001', 'user@cinema.com', NULL, 0, 0, 0, NOW(), NOW());
```

---

### 2. 电影表 (movie)

**表名**: `movie`

**表说明**: 存储电影基本信息

**字段说明**:

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|--------|------|------|--------|--------|------|
| id | bigint |  | NO |  | 主键，自增 |
| name | varchar | 100 | NO |  | 电影名称 |
| name_en | varchar | 100 | YES | NULL | 英文名称 |
| director | varchar | 100 | YES | NULL | 导演 |
| actors | varchar | 500 | YES | NULL | 主演（逗号分隔） |
| type | varchar | 50 | YES | NULL | 类型（逗号分隔） |
| area | varchar | 50 | YES | NULL | 地区 |
| language | varchar | 50 | YES | NULL | 语言 |
| duration | int |  | YES | NULL | 时长（分钟） |
| release_date | date |  | YES | NULL | 上映日期 |
| rating | decimal | (3,1) | YES | NULL | 评分（0-10） |
| poster | varchar | 255 | YES | NULL | 海报URL |
| description | text |  | YES | NULL | 剧情简介 |
| status | int |  | YES | 0 | 状态：0-即将上映，1-正在热映，2-已下架 |
| deleted | int |  | YES | 0 | 逻辑删除 |
| create_time | datetime |  | YES | CURRENT_TIMESTAMP | 创建时间 |
| update_time | datetime |  | YES | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- PRIMARY KEY: `id`

---

### 3. 影厅表 (hall)

**表名**: `hall`

**表说明**: 存储影厅信息和座位布局

**字段说明**:

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|--------|------|------|--------|--------|------|
| id | bigint |  | NO |  | 主键，自增 |
| name | varchar | 50 | NO |  | 影厅名称 |
| type | int |  | YES | 0 | 类型：0-2D，1-3D，2-IMAX |
| row_count | int |  | NO |  | 总行数 |
| col_count | int |  | NO |  | 总列数 |
| seat_count | int |  | NO |  | 总座位数 |
| seat_layout | text |  | YES | NULL | 座位布局（JSON格式） |
| status | int |  | YES | 0 | 状态：0-正常，1-维护中 |
| deleted | int |  | YES | 0 | 逻辑删除 |
| create_time | datetime |  | YES | CURRENT_TIMESTAMP | 创建时间 |
| update_time | datetime |  | YES | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- PRIMARY KEY: `id`

**座位布局说明**:

座位布局使用 JSON 格式存储，可以标记特殊座位（如过道、情侣座等）。简化版直接使用行列计算。

---

### 4. 排片表 (schedule)

**表名**: `schedule`

**表说明**: 存储电影排片信息

**字段说明**:

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|--------|------|------|--------|--------|------|
| id | bigint |  | NO |  | 主键，自增 |
| movie_id | bigint |  | NO |  | 电影ID（外键） |
| hall_id | bigint |  | NO |  | 影厅ID（外键） |
| start_time | datetime |  | NO |  | 开始时间 |
| end_time | datetime |  | NO |  | 结束时间 |
| price | decimal | (10,2) | NO |  | 票价 |
| sold_count | int |  | YES | 0 | 已售座位数 |
| status | int |  | YES | 0 | 状态：0-未开始，1-售票中，2-已结束 |
| deleted | int |  | YES | 0 | 逻辑删除 |
| create_time | datetime |  | YES | CURRENT_TIMESTAMP | 创建时间 |
| update_time | datetime |  | YES | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- PRIMARY KEY: `id`
- INDEX: `idx_movie_id` (`movie_id`)
- INDEX: `idx_hall_id` (`hall_id`)
- INDEX: `idx_start_time` (`start_time`)

**业务规则**:
1. 同一影厅在同一时间段不能有重叠的排片
2. 结束时间 = 开始时间 + 电影时长 + 清场时间（约15分钟）

---

### 5. 订单表 (order_info)

**表名**: `order_info`

**表说明**: 存储用户订单信息

**字段说明**:

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|--------|------|------|--------|--------|------|
| id | bigint |  | NO |  | 主键，自增 |
| order_no | varchar | 50 | NO |  | 订单号（唯一） |
| user_id | bigint |  | NO |  | 用户ID（外键） |
| schedule_id | bigint |  | NO |  | 排片ID（外键） |
| seats | text |  | NO |  | 座位信息（JSON格式） |
| ticket_count | int |  | NO |  | 票数 |
| total_amount | decimal | (10,2) | NO |  | 总金额 |
| status | int |  | YES | 0 | 状态：0-待支付，1-已支付，2-已取消，3-已退款 |
| pay_time | datetime |  | YES | NULL | 支付时间 |
| deleted | int |  | YES | 0 | 逻辑删除 |
| create_time | datetime |  | YES | CURRENT_TIMESTAMP | 创建时间 |
| update_time | datetime |  | YES | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_order_no` (`order_no`)
- INDEX: `idx_user_id` (`user_id`)
- INDEX: `idx_schedule_id` (`schedule_id`)

**座位信息格式**:

```json
[
  {"row": 5, "col": 10},
  {"row": 5, "col": 11}
]
```

**订单状态流转**:

```
待支付(0) → 已支付(1)
   ↓
已取消(2)

已支付(1) → 已退款(3)
```

---

## ER 图

```
┌─────────────┐
│    User     │
│ (用户表)    │
└──────┬──────┘
       │
       │ 1
       │
       │ n
┌──────▼──────┐        n ┌─────────────┐ 1       ┌─────────────┐
│    Order    │◄─────────│  Schedule   │◄────────│    Movie    │
│  (订单表)   │          │  (排片表)   │         │  (电影表)   │
└─────────────┘          └──────┬──────┘         └─────────────┘
                                │
                                │ 1
                                │
                                │ n
                         ┌──────▼──────┐
                         │    Hall     │
                         │  (影厅表)   │
                         └─────────────┘
```

## 表关系说明

1. **用户 与 订单**：一对多
   - 一个用户可以创建多个订单
   - 外键：order.user_id → user.id

2. **排片 与 订单**：一对多
   - 一个排片可以对应多个订单
   - 外键：order.schedule_id → schedule.id

3. **电影 与 排片**：一对多
   - 一部电影可以有多个排片
   - 外键：schedule.movie_id → movie.id

4. **影厅 与 排片**：一对多
   - 一个影厅可以有多个排片
   - 外键：schedule.hall_id → hall.id

## 数据完整性

### 1. 主键约束
所有表都有自增主键 `id`

### 2. 唯一约束
- user.username：保证用户名唯一
- order_info.order_no：保证订单号唯一

### 3. 外键关系（逻辑外键）
虽然未使用物理外键，但在应用层维护以下关系：
- order_info.user_id → user.id
- order_info.schedule_id → schedule.id
- schedule.movie_id → movie.id
- schedule.hall_id → hall.id

### 4. 逻辑删除
所有表都使用 `deleted` 字段实现逻辑删除，避免数据丢失

## 性能优化

### 1. 索引设计

**user 表**:
- PRIMARY KEY (id)：主键索引
- UNIQUE KEY (username)：唯一索引，用于登录查询

**schedule 表**:
- INDEX (movie_id)：查询电影排片
- INDEX (hall_id)：查询影厅排片
- INDEX (start_time)：按时间查询排片

**order_info 表**:
- INDEX (user_id)：查询用户订单
- INDEX (schedule_id)：查询排片订单

### 2. 查询优化建议

1. **分页查询**：使用 LIMIT OFFSET 进行分页
2. **避免 SELECT ***：只查询需要的字段
3. **使用覆盖索引**：减少回表查询
4. **合理使用 JOIN**：避免过多表连接

### 3. 数据归档

定期归档历史订单数据：
- 已结束的排片
- 已完成/已取消的订单
- 历史统计数据

## 扩展建议

### 1. 增加表

- **评论表 (comment)**：存储用户对电影的评论
- **优惠券表 (coupon)**：优惠券信息
- **会员表 (membership)**：会员等级信息
- **支付记录表 (payment)**：详细的支付流水

### 2. 字段扩展

**user 表**:
- birthday：生日
- gender：性别
- member_level：会员等级

**movie 表**:
- box_office：票房
- comment_count：评论数
- view_count：浏览量

**order_info 表**:
- payment_method：支付方式
- coupon_id：使用的优惠券

## 备份策略

### 1. 全量备份
每天凌晨 2:00 进行全量备份

```bash
mysqldump -u root -p cinema_db > backup_$(date +%Y%m%d).sql
```

### 2. 增量备份
启用 binlog 进行增量备份

```sql
-- 查看 binlog 状态
SHOW BINARY LOGS;

-- 刷新 binlog
FLUSH LOGS;
```

### 3. 数据恢复

```bash
# 恢复全量备份
mysql -u root -p cinema_db < backup_20240120.sql

# 恢复增量备份
mysqlbinlog binlog.000001 | mysql -u root -p cinema_db
```

## 总结

本数据库设计遵循了规范化原则，具有以下特点：

1. **结构清晰**：5 张核心表，关系明确
2. **扩展性好**：预留了扩展字段和表
3. **性能优化**：合理的索引设计
4. **数据安全**：逻辑删除 + 备份策略

通过合理的数据库设计，为系统的稳定运行和后续扩展打下了坚实基础。

