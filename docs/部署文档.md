# 影院管理系统部署文档

## 环境要求

### 后端环境

- JDK 1.8 或以上
- Maven 3.6+
- MySQL 8.0+
- Redis 6.2+ (可选)

### 前端环境

- Node.js 16+
- npm 或 yarn

## 后端部署

### 1. 数据库准备

#### 安装 MySQL

```bash
# Windows: 下载安装包安装
# Linux (Ubuntu):
sudo apt-get update
sudo apt-get install mysql-server

# 启动 MySQL
sudo service mysql start
```

#### 创建数据库并导入数据

```bash
# 登录 MySQL
mysql -u root -p

# 执行 SQL 脚本
mysql -u root -p < sql/cinema.sql
```

或者在 MySQL 客户端中执行：

```sql
source /path/to/cinema.sql;
```

### 2. 修改配置文件

编辑 `backend/src/main/resources/application.yml`：

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/cinema_db?useUnicode=true&characterEncoding=utf-8&useSSL=false&serverTimezone=Asia/Shanghai
    username: root
    password: your_password  # 修改为你的数据库密码
  
  redis:
    host: localhost
    port: 6379
    password:  # 如果 Redis 有密码，在此填写
```

### 3. 编译打包

```bash
cd backend
mvn clean package -DskipTests
```

生成的 jar 包位于 `target/cinema-management-system-1.0.0.jar`

### 4. 运行应用

#### 开发环境运行

```bash
cd backend
mvn spring-boot:run
```

#### 生产环境运行

```bash
java -jar target/cinema-management-system-1.0.0.jar
```

#### 后台运行

```bash
nohup java -jar target/cinema-management-system-1.0.0.jar > cinema.log 2>&1 &
```

#### 使用自定义配置

```bash
java -jar target/cinema-management-system-1.0.0.jar --spring.config.location=/path/to/application.yml
```

### 5. 验证部署

访问 `http://localhost:8080/api` 查看是否正常运行。

## 前端部署

### 1. 安装依赖

```bash
cd frontend
npm install
# 或
yarn install
```

### 2. 开发环境运行

```bash
npm start
# 或
yarn start
```

访问 `http://localhost:3000`

### 3. 生产环境打包

```bash
npm run build
# 或
yarn build
```

打包后的文件在 `build/` 目录下。

### 4. 部署到服务器

#### 使用 Nginx

1. 安装 Nginx

```bash
# Ubuntu
sudo apt-get install nginx

# CentOS
sudo yum install nginx
```

2. 配置 Nginx

创建配置文件 `/etc/nginx/sites-available/cinema`：

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 前端静态文件
    location / {
        root /var/www/cinema/frontend;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # 后端 API 代理
    location /api {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

3. 启用配置并重启 Nginx

```bash
sudo ln -s /etc/nginx/sites-available/cinema /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

4. 复制前端文件到服务器

```bash
sudo mkdir -p /var/www/cinema/frontend
sudo cp -r build/* /var/www/cinema/frontend/
```

## Docker 部署（可选）

### 1. 后端 Dockerfile

创建 `backend/Dockerfile`：

```dockerfile
FROM openjdk:8-jdk-alpine
VOLUME /tmp
COPY target/cinema-management-system-1.0.0.jar app.jar
ENTRYPOINT ["java","-jar","/app.jar"]
```

### 2. 前端 Dockerfile

创建 `frontend/Dockerfile`：

```dockerfile
FROM node:16 AS build
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=build /app/build /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

### 3. Docker Compose

创建 `docker-compose.yml`：

```yaml
version: '3'
services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: cinema_db
    ports:
      - "3306:3306"
    volumes:
      - ./sql/cinema.sql:/docker-entrypoint-initdb.d/cinema.sql

  redis:
    image: redis:6.2-alpine
    ports:
      - "6379:6379"

  backend:
    build: ./backend
    ports:
      - "8080:8080"
    depends_on:
      - mysql
      - redis

  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend
```

运行：

```bash
docker-compose up -d
```

## 常见问题

### 1. 数据库连接失败

**问题:** `Communications link failure`

**解决:**
- 检查 MySQL 是否启动
- 检查数据库用户名密码是否正确
- 检查防火墙设置

### 2. 端口占用

**问题:** `Address already in use`

**解决:**

```bash
# 查看端口占用
# Linux
netstat -anp | grep 8080
# Windows
netstat -ano | findstr 8080

# 杀死进程
kill -9 <PID>
```

### 3. 前端无法访问后端

**问题:** 跨域错误或 404

**解决:**
- 检查后端是否正常运行
- 检查 Nginx 代理配置
- 检查 CORS 配置

### 4. 内存不足

**解决:** 限制 JVM 内存

```bash
java -Xms512m -Xmx1024m -jar app.jar
```

## 性能优化建议

### 1. 数据库优化

- 添加索引
- 定期清理日志
- 使用主从复制

### 2. 应用优化

- 启用 Redis 缓存
- 配置连接池大小
- 启用 Gzip 压缩

### 3. 服务器优化

- 增加服务器内存
- 使用 CDN 加速静态资源
- 启用负载均衡

## 监控与日志

### 1. 应用日志

日志文件位置：`logs/cinema.log`

查看日志：

```bash
tail -f logs/cinema.log
```

### 2. 系统监控

推荐使用：
- Prometheus + Grafana
- Spring Boot Admin
- ELK Stack

## 备份策略

### 1. 数据库备份

```bash
# 备份
mysqldump -u root -p cinema_db > backup_$(date +%Y%m%d).sql

# 恢复
mysql -u root -p cinema_db < backup_20240120.sql
```

### 2. 定时备份

添加 crontab 任务：

```bash
0 2 * * * /usr/bin/mysqldump -u root -p cinema_db > /backup/cinema_$(date +\%Y\%m\%d).sql
```

## 安全建议

1. **修改默认密码**
   - 数据库密码
   - Redis 密码

2. **启用 HTTPS**
   - 申请 SSL 证书
   - 配置 Nginx SSL

3. **限制访问**
   - 配置防火墙
   - 使用安全组

4. **定期更新**
   - 更新依赖包
   - 修复安全漏洞

## 总结

按照以上步骤即可完成影院管理系统的部署。建议在生产环境中使用 Nginx 作为反向代理，并配置 HTTPS。同时做好数据备份和监控工作，确保系统稳定运行。

